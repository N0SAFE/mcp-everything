# Development Dockerfile for Web App with HMR
FROM node:22-alpine AS base

# Install dependencies only when needed
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Install Turbo globally
RUN npm install -g turbo@^2

# Copy root package files
COPY package*.json ./
COPY turbo.json ./

# Copy workspace package files
COPY apps/web/package*.json ./apps/web/
COPY packages/*/package*.json ./packages/*/

# Install dependencies
RUN npm install

# Development runner
FROM base AS runner
RUN apk add --no-cache libc6-compat su-exec
WORKDIR /app

# Install Turbo globally
RUN npm install -g turbo@^2

# Copy dependencies
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/apps/web/node_modules ./apps/web/node_modules

# Copy all source files
COPY . .

# Set build-time environment variables for Next.js
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_API_PORT
ARG NEXT_PUBLIC_APP_URL
ARG NEXT_PUBLIC_APP_PORT
ARG API_PING_PATH
ARG API_ADMIN_TOKEN
ARG AUTH_SECRET
ARG USER_ID=1000
ARG GROUP_ID=1000

ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_API_PORT=$NEXT_PUBLIC_API_PORT
ENV NEXT_PUBLIC_APP_URL=$NEXT_PUBLIC_APP_URL
ENV NEXT_PUBLIC_APP_PORT=$NEXT_PUBLIC_APP_PORT
ENV API_PING_PATH=$API_PING_PATH
ENV API_ADMIN_TOKEN=$API_ADMIN_TOKEN
ENV AUTH_SECRET=$AUTH_SECRET

# Create nextjs user for development
# Use higher UID/GID to avoid conflicts with system users
RUN addgroup -g 10001 -S nodejs && \
    adduser -S nextjs -u 10001 -G nodejs

# For development, we'll run as root to avoid permission issues with mounted volumes
# In production, we use the nextjs user for security
# Change ownership of the app directory
RUN chown -R nextjs:nodejs ./

# Don't switch to nextjs user in development to avoid volume permission issues
# USER nextjs

# Expose port
EXPOSE 3003

# Set environment variables for development
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1

# Create an entrypoint script to fix permissions and run as the correct user
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo '# Fix ownership of mounted volumes' >> /entrypoint.sh && \
    echo 'chown -R nextjs:nodejs /app/apps/web/src/routes 2>/dev/null || mkdir -p /app/apps/web/src/routes && chown -R nextjs:nodejs /app/apps/web/src/routes' >> /entrypoint.sh && \
    echo 'chown -R nextjs:nodejs /app/apps/web/.next 2>/dev/null || true' >> /entrypoint.sh && \
    echo '# Execute command as nextjs user' >> /entrypoint.sh && \
    echo 'exec su-exec nextjs "$@"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Start the development server using the entrypoint script
ENTRYPOINT ["/entrypoint.sh"]
CMD ["npm", "run", "dev:docker", "--workspace=web"]
